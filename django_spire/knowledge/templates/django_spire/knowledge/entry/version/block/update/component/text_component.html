<div
    class="d-flex align-items-center"
    x-data="{
        init() {
            $nextTick(() => {
                $refs.textarea.style.height = 'auto'
                $refs.textarea.style.height = $refs.textarea.scrollHeight + 'px'
            })
        },
        async create_block() {
            const version_block = await create_blank_block({block_type: 'text', order: version_block.order + 1})
            $dispatch('update_block_order_focus', {order: version_block.order + 1, cursor_position: 0})
        },
        async delete_if_empty() {
            if (version_block.block.value === '') {
                const previous_order = version_block.order - 1
                if (previous_order === 0) {
                    return
                }
                const previous_block_length = manager.get_block_length({order: previous_order})
                $dispatch(
                    'update_block_order_focus',
                    {order: previous_order, cursor_position: previous_block_length}
                )
                await delete_block({version_block_id: version_block.id})
            }
        },
        async update_text_value() {
            let response = await django_glue_fetch(
                '{% url "django_spire:knowledge:entry:version:block:json:update_text" pk=version_block.pk %}',
                {payload: {
                    value: version_block.block.value,
                    block_type: version_block.block.type
                }},
            )

            if (response.type === 'error') {
                $dispatch('notify', {type: 'error', message: 'An error occurred while saving the text block.'})
            }
        },
        update_height(event) {
            event.target.style.height = 'auto'
            event.target.style.height = event.target.scrollHeight + 'px'
        },
        update_focus({order, cursor_position}) {
            if (order === version_block.order) {
                $refs.textarea.focus()
                $refs.textarea.setSelectionRange(cursor_position, cursor_position)
                manager.update_block_order_focus({order: order})
            }
        },
        {% block x_data %}
        {% endblock %}
    }"
    @update_block_order_focus.window="
        update_focus({order: $event.detail.order, cursor_position: $event.detail.cursor_position})
    "
>
    <style>
        textarea:focus {
            outline: none;
            border: none;
        }
    </style>
    {% block before_text_content %}
    {% endblock %}
    <textarea
        rows="1"
        class="w-100 border-0 bg-transparent px-1 auto-resize overflow-y-hidden {% block textarea_class %}fs-6{% endblock %}"
        style="height: 30px; resize: none;"
        x-ref="textarea"
        x-model="version_block.block.value"
        @input="update_height($event)"
        @focus="update_focus({order: version_block.order, cursor_position: $event.target.selectionStart})"
        :placeholder="manager.block_order_focus === version_block.order ? 'Write something...' : ''"
        @beforeinput.debounce.300ms="update_text_value()"
        @keydown.backspace="delete_if_empty()"
        {% block shift_enter_event %}
        @keydown.shift.enter.prevent="create_block()"
        {% endblock %}
        @keydown.up.prevent="$dispatch('update_block_order_focus', {order: version_block.order - 1, cursor_position: $event.target.selectionStart})"
        @keydown.down.prevent="$dispatch('update_block_order_focus', {order: version_block.order + 1, cursor_position: $event.target.selectionStart})"
        {% block textarea_attributes %}
        {% endblock %}
    ></textarea>
</div>
