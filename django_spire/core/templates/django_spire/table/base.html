<div
    x-data="{
        endpoint: '{{ endpoint }}',
        child_endpoint: '{{ child_endpoint|default:'' }}',
        page_size: parseInt('{{ page_size|default:25 }}'),
        shared_payload: {},

        current_page: parseInt('{{ current_page|default:0 }}'),
        has_next: {{ has_next|default:'true'|yesno:'true,false' }},
        loaded_count: 0,
        total_count: parseInt('{{ total_count|default:0 }}'),

        column_count: 0,
        is_loading: false,
        is_refreshing: false,

        observer: null,
        select_all: false,
        selected_rows: new Set(),
        skeleton_count: 0,
        skeleton_row: parseInt('{{ page_size|default:25 }}'),

        sort_column: {% if sort_column %}'{{ sort_column }}'{% else %}null{% endif %},
        sort_direction: '{{ sort_direction|default:'asc' }}',

        child_rows: {},
        is_child_row_loading: {},
        is_row_open: {},

        {% block table_xdata %}{% endblock %}

        async init() {
            await this.$nextTick();
            this.reset_scroll_position();

            if (this.should_load_initial_data()) {
                this.skeleton_count = this.skeleton_row;
                await this.load_more();
            }

            if (this.has_next) {
                setTimeout(() => this.setup_observer(), 500);
            }
        },

        should_load_initial_data() {
            return this.loaded_count === 0 && this.current_page === 0;
        },

        reset_scroll_position() {
            requestAnimationFrame(() => {
                if (this.$refs.table_container) {
                    this.$refs.table_container.scrollTop = 0;
                }
            });
        },

        handle_header_mounted(event) {
            this.column_count = event.detail.count;
        },

        handle_row_mounted() {
            this.loaded_count++;
        },

        handle_rows_cleared() {
            this.loaded_count = 0;
            this.selected_rows.clear();
            this.select_all = false;
        },

        async setup_observer() {
            let trigger = this.$refs.infinite_scroll_trigger;
            if (!trigger) {
                console.error('Infinite scroll trigger element not found.');
                return;
            }

            let options = {
                root: null,
                rootMargin: '200px',
                threshold: 0.01
            };

            this.observer = new IntersectionObserver(
                (entries) => {
                    entries.forEach(async entry => {
                        if (entry.isIntersecting && this.has_next && !this.is_loading) {
                            await this.load_more();
                        }
                    });
                },
                options
            );

            this.observer.observe(trigger);
        },

        disconnect_observer() {
            if (this.observer) {
                this.observer.disconnect();
            }
        },

        async fetch_rows(next_page) {
            if (!this.endpoint) {
                return { success: false, error: 'No endpoint provided' };
            }

            let params = this.build_request_params(next_page);
            let url = `${this.endpoint}?${params}`;
            let view = new ViewGlue(url, this.$refs.shared_payload ? JSON.parse(this.$refs.shared_payload.textContent) : {});

            if (next_page === 1) {
                this.$dispatch('clear-rows');
                this.$refs.table_body.innerHTML = '';
            }

            let previous_count = this.loaded_count;
            await view.render_insert_adjacent(this.$refs.table_body, {}, 'beforeend');
            let added = this.loaded_count - previous_count;

            return { success: true, added: added };
        },

        build_request_params(next_page) {
            let params = new URLSearchParams({
                page: next_page,
                page_size: this.page_size
            });

            if (this.sort_column) {
                params.set('sort', this.sort_column);
                params.set('direction', this.sort_direction);
            }

            return params;
        },

        async load_more() {
            if (!this.endpoint) {
                return;
            }

            this.is_loading = true;

            if (!this.$refs.table_body) {
                console.error('Table body not found');
                this.cleanup_loading_state();
                return;
            }

            let result = await this.fetch_rows(this.current_page + 1);

            if (!result.success) {
                this.cleanup_loading_state();
                return;
            }

            if (result.added > 0) {
                this.current_page++;
            }

            if (result.added < this.page_size) {
                this.has_next = false;
                this.disconnect_observer();
            }

            this.cleanup_loading_state();

            await this.$nextTick();
            await this.check_container_height();
        },

        cleanup_loading_state() {
            this.is_loading = false;
            this.skeleton_count = 0;
        },

        async check_container_height() {
            let table_container = this.$refs.table_container;

            if (table_container && this.has_next && !this.is_refreshing) {
                if (table_container.scrollHeight <= table_container.clientHeight) {
                    await this.load_more();
                }
            }
        },

        handle_toggle_row(event) {
            let row_id = event.detail.row_id;
            this.is_row_open[row_id] = !this.is_row_open[row_id];

            this.$dispatch('toggle-row-state', { row_id: row_id, is_open: this.is_row_open[row_id] });

            if (this.is_row_open[row_id] && !this.child_rows[row_id] && this.child_endpoint) {
                this.load_child_rows(row_id);
            }
        },

        async load_child_rows(parent_id) {
            if (this.is_child_row_loading[parent_id]) {
                return;
            }

            this.is_child_row_loading[parent_id] = true;
            this.$dispatch('toggle-row-state', { row_id: parent_id, is_open: true, is_loading: true });

            let url = this.child_endpoint.replace('{id}', parent_id);
            let view = new ViewGlue(url, this.$refs.shared_payload ? JSON.parse(this.$refs.shared_payload.textContent) : {});

            let temp_container = document.createElement('div');
            await view.render_inner(temp_container);

            this.child_rows[parent_id] = temp_container.innerHTML;

            this.$nextTick(() => {
                this.$dispatch('update-child-row', { parent_id: parent_id, content: this.child_rows[parent_id] });
            });

            this.is_child_row_loading[parent_id] = false;
            this.$dispatch('toggle-row-state', { row_id: parent_id, is_open: true, is_loading: false });
        },

        async refresh_table() {
            this.is_refreshing = true;
            await this.$nextTick();

            this.reset_table_state();
            let result = await this.fetch_rows(1);
            this.update_counts_after_refresh(result);

            this.disconnect_observer();

            if (this.has_next) {
                setTimeout(() => this.setup_observer(), 100);
            }

            this.is_refreshing = false;
        },

        reset_table_state() {
            this.child_rows = {};
            this.current_page = 1;
            this.has_next = true;
            this.is_child_row_loading = {};
            this.is_row_open = {};
        },

        update_counts_after_refresh(result) {
            if (result && result.added < this.page_size) {
                this.has_next = false;
            }
        },

        async sort_by(column) {
            if (this.sort_column === column) {
                this.sort_direction = this.sort_direction === 'asc' ? 'desc' : 'asc';
            } else {
                this.sort_column = column;
                this.sort_direction = 'asc';
            }

            await this.refresh_table();
        },

        get_sort_icon(column) {
            if (this.sort_column !== column) {
                return 'bi-chevron-expand';
            }
            return this.sort_direction === 'asc' ? 'bi-chevron-up' : 'bi-chevron-down';
        },

        handle_toggle_all() {
            this.select_all = !this.select_all;

            if (this.select_all) {
                this.$dispatch('select-all-rows');
            } else {
                this.selected_rows.clear();
                this.$dispatch('deselect-all-rows');
            }
        },

        handle_row_selected(event) {
            this.selected_rows.add(event.detail.row_id);
        },

        handle_row_deselected(event) {
            this.selected_rows.delete(event.detail.row_id);
        },

        handle_toggle_row(event) {
            let row_id = event.detail.row_id;
            this.is_row_open[row_id] = !this.is_row_open[row_id];

            this.$dispatch('toggle-row-state', { row_id: row_id, is_open: this.is_row_open[row_id] });

            if (this.is_row_open[row_id] && !this.child_rows[row_id] && this.child_endpoint) {
                this.load_child_rows(row_id);
            }
        },
    }"
    @clear-rows.window="handle_rows_cleared()"
    @header-mounted="handle_header_mounted($event)"
    @row-deselected.window="handle_row_deselected($event)"
    @row-mounted.window="handle_row_mounted()"
    @row-selected.window="handle_row_selected($event)"
    @toggle-row.window="handle_toggle_row($event)"
>
    <script type="application/json" x-ref="shared_payload">{% if shared_payload %}{{ shared_payload|safe }}{% else %}{}{% endif %}</script>

    {% block table_toolbar %}{% endblock %}

    {% block table_container %}
        <div
            class="position-relative table-container"
            style="max-height: {{ table_height|default:'600px' }}; overflow-y: auto; overscroll-behavior: contain;"
            x-ref="table_container"
        >
            <table class="table table-striped table-hover fs-7 {% block table_class %}{% endblock %}" style="table-layout: fixed;">
                <thead class="z-1 {% block table_head_class %}bg-app-layer-two sticky-top{% endblock %}">
                    <tr
                        x-init="column_count = $el.children.length; $dispatch('header-mounted', { count: column_count })"
                        x-ref="header_row"
                    >
                        {% block table_header %}
                            {% include 'django_spire/table/element/header.html' %}
                        {% endblock %}
                    </tr>
                </thead>

                {% include 'django_spire/table/element/refreshing_skeleton.html' %}

                <tbody x-ref="table_body" x-show="!is_refreshing">
                    {% block table_body %}
                    {% endblock %}
                </tbody>

                {% include 'django_spire/table/element/loading_skeleton.html' %}
            </table>

            {% block trigger %}
                {% include 'django_spire/table/element/trigger.html' %}
            {% endblock %}
        </div>
    {% endblock %}

    {% block table_footer %}
        {% include 'django_spire/table/element/footer.html' %}
    {% endblock %}
</div>
