<div
    x-data="{
        loaded_tabs: new Set(),
        loading_tabs: new Set(),
        selected_tab: 1,
        tab_id: '{{ tab_id|default:'tab' }}',

        init() {
            let url_tab = this.get_url_param();

            if (url_tab) {
                this.selected_tab = url_tab;
            }

            this.$nextTick(() => this.load_tab_content(this.selected_tab));
        },

        select(tab_number) {
            this.selected_tab = tab_number;
            this.update_url(tab_number);
            this.load_tab_content(tab_number);

            this.$dispatch('tab-changed', {
                tab_id: this.tab_id,
                tab_number: tab_number
            });
        },

        is_selected(tab_number) {
            return this.selected_tab === tab_number;
        },

        is_loaded(tab_number) {
            return this.loaded_tabs.has(tab_number);
        },

        is_loading(tab_number) {
            return this.loading_tabs.has(tab_number);
        },

        async load_tab_content(tab_number) {
            if (this.is_loaded(tab_number) || this.is_loading(tab_number)) {
                return;
            }

            let endpoint = this.get_tab_endpoint(tab_number);
            let target_ref = this.$refs[`tab_content_${tab_number}`];

            if (!endpoint || !target_ref) {
                this.loaded_tabs.add(tab_number);
                return;
            }

            this.loading_tabs.add(tab_number);

            toggle_loading_overlay();
            let view = new ViewGlue(endpoint);
            await view.render_inner(target_ref);

            this.loading_tabs.delete(tab_number);
            this.loaded_tabs.add(tab_number);
            toggle_loading_overlay();
        },

        get_tab_endpoint(tab_number) {
            {% block tab_endpoints %}
            {% endblock %}
        },

        get_url_param() {
            let url = new URL(window.location);
            let value = url.searchParams.get(this.tab_id);
            let parsed = parseInt(value, 10);

            if (!isNaN(parsed) && parsed > 0) {
                return parsed;
            }

            return null;
        },

        update_url(tab_number) {
            let url = new URL(window.location);
            url.searchParams.set(this.tab_id, tab_number);
            window.history.replaceState({}, '', url);
        },

        which_tab(el) {
            return parseInt(el.dataset.tabNumber, 10);
        }
    }"
>
    <ul
        @keydown.right.prevent.stop="$focus.wrap().next()"
        @keydown.home.prevent.stop="$focus.first()"
        @keydown.page-up.prevent.stop="$focus.first()"
        @keydown.left.prevent.stop="$focus.wrap().prev()"
        @keydown.end.prevent.stop="$focus.last()"
        @keydown.page-down.prevent.stop="$focus.last()"
        class="border-1 border-bottom d-flex list-unstyled"
        role="tablist"
    >
        {% block tab_triggers %}
        {% endblock %}
    </ul>

    {% block tab_function_area %}
    {% endblock %}

    <div>
        {% block tab_sections %}
        {% endblock %}
    </div>
</div>
