{% extends 'django_spire/speech/speech_recognition.html' %}

{% block speech_recognition_content %}
    <div class="row" x-data="{
            chat_id: '{{ chat.id }}',
            load_messages_view: new ViewGlue('{% url "django_spire:ai:chat:message:load_chat" chat_id=chat.id %}'),
            message_body: '',
            request_message_view: new ViewGlue('{% url "django_spire:ai:chat:message:request:new" %}'),

            init() {
                setTimeout(() => {
                    if (this.$refs.target_div) {
                        this.$refs.target_div.scrollTop = this.$refs.target_div.scrollHeight
                    }
                }, 1500)

                this.speech_recognition.onresult = () => {
                    this.message_body = this.speech_transcript
                    this.send_chat({message_body: this.message_body, synthesis_speech_for_response: true})
                }
            },
            load_messages() {
                this.load_messages_view.render_insert_adjacent(this.$refs.target_div, {})
            },
            async send_chat({message_body = '', synthesis_speech_for_response = false}) {
                if (message_body !== '') {
                    await this.request_message_view.render_insert_adjacent(
                        this.$refs.target_div,
                        {
                            chat_id: this.chat_id,
                            message_body: message_body,
                            synthesis_speech: synthesis_speech_for_response
                        }
                    )
                    this.message_body = ''
                }
            },
            speak_text(text) {
                if ('speechSynthesis' in window) {
                    let utterance = new SpeechSynthesisUtterance(text)
                    window.speechSynthesis.speak(utterance)
                }
            }
        }" @send-message.window="send_chat({message_body: $event.detail.message_body})" @speak.window="speak_text($event.detail.text)">
        <div class="col-12">
            <div class="row border-bottom px-0">
                <div class="col text-center fw-bold pb-2">
                    {{ chat.name_shortened }}
                </div>
            </div>

            <div class="row mb-3">
                <div class="col-12 overflow-auto p-4" style="height: calc(100vh - 90px - var(--app-top-navigation-height));" x-init="load_messages()" x-ref="target_div">
                </div>
            </div>

            <div class="row">
                <div class="col-auto text-center ps-2 pe-1">
                    <button @click="start_listening()" class="btn btn-app-primary-outlined" x-show="!speech_listening">
                        <i class="bi bi-mic"></i>
                    </button>
                    <button @click="stop_listening()" class="btn btn-app-danger" x-show="speech_listening">
                        <i class="bi bi-mic-fill"></i>
                    </button>
                </div>
                <div class="col text-center px-1">
                    <input @keyup.enter="send_chat({message_body: message_body})" autocomplete="off" class="form-control" name="request_message" type="text" x-init="$el.focus()" x-model="message_body">
                </div>
                <div class="col-auto text-center ps-1 pe-2">
                    <button @click="send_chat({message_body: message_body})" class="btn btn-app-primary-outlined">
                        <i class="bi bi-send"></i>
                    </button>
                </div>
            </div>

        </div>
    </div>
{% endblock %}
