<div class="bg-app-layer-one px-3 py-4">
    {% for task_user in task_users %}
        <div
            class="ps-4 {% if task_users|length > 1 and not forloop.last %}border-bottom pb-3 mb-3{% endif %}"
            x-data="{
                is_loading: false,
                is_open: false,
                has_loaded: false,

                async load_user_details() {
                    if (this.is_open) {
                        this.is_open = false;
                        return;
                    }

                    if (this.is_loading) {
                        return;
                    }

                    this.is_loading = true;

                    if (!this.has_loaded) {
                        let url = '/tabular/template/api/user/{{ task_user.user.id }}/details/';
                        let view = new ViewGlue(url, {});

                        await view.render_inner(this.$refs.user_details);
                        this.has_loaded = true;
                    }

                    this.is_loading = false;

                    this.is_open = true;
                }
            }"
        >
            <div class="d-flex align-items-center gap-2">
                <i class="bi bi-arrow-return-right text-muted"></i>
                <strong>{{ task_user.user.get_full_name|default:task_user.user.username }}</strong>
                <span class="badge bg-secondary">{{ task_user.get_role_display }}</span>
                <i
                    @click="load_user_details()"
                    class="bi cursor-pointer text-primary"
                    :class="is_loading
                        ? 'bi-arrow-clockwise spin'
                        : (is_open ? 'bi-chevron-up' : 'bi-info-circle')"
                ></i>
            </div>

            <div class="ms-4 small text-muted">
                <div class="d-none d-lg-block">Price: ${{ task_user.calculated_price|floatformat:2 }}</div>
                <div>Cost: ${{ task_user.calculated_cost|floatformat:2 }}</div>
                <div class="d-none d-md-block">{{ task_user.created_datetime|date:"M d, Y" }}</div>
            </div>

            <div
                class="ms-4 mt-2"
                x-cloak
                x-show="is_open"
                x-collapse
                x-ref="user_details"
            ></div>
        </div>
    {% endfor %}
</div>
